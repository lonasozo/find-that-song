<!DOCTYPE html>
<html>
  <head>
    <title>Your Top Tracks</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <div class="container">
      <h2>Top Tracks</h2>
      
      <% if (!locals.layout) { %>
        <!-- This section is returned for AJAX calls -->
        <div class="tracks-grid">
            <% tracks.forEach((track, index) => { %>
                <div class="track-card">
                    <!-- Track content -->
                    <div class="track-number"><%= index + 1 %></div>
                    <div class="track-image">
                        <img src="<%= track.album.images[0]?.url || '/img/default-album.png' %>" alt="<%= track.name %>">
                    </div>
                    <div class="track-info">
                        <div class="track-name"><%= track.name %></div>
                        <div class="track-artist"><%= track.artists.map(artist => artist.name).join(', ') %></div>
                        <div class="track-album"><%= track.album.name %></div>
                    </div>
                    <div class="track-actions">
                        <a href="<%= track.external_urls.spotify %>" target="_blank" class="spotify-link">
                            <i class="fas fa-external-link-alt"></i> Open in Spotify
                        </a>
                    </div>
                </div>
            <% }); %>
        </div>
      <% } else { %>
        <!-- This is the full page for initial load -->
        <div class="content-header">
            <h1>Your Top Tracks</h1>
            
            <div class="time-range-container">
                <div class="time-range-label">Time Range:</div>
                <div class="time-range-buttons">
                    <button type="button" 
                            class="time-range-button <%= time_range === 'short_term' ? 'active' : '' %>" 
                            data-time-range="short_term" 
                            data-content-type="top-tracks" 
                            data-access-token="<%= access_token %>">
                        Last 4 Weeks
                    </button>
                    <button type="button" 
                            class="time-range-button <%= time_range === 'medium_term' ? 'active' : '' %>" 
                            data-time-range="medium_term" 
                            data-content-type="top-tracks" 
                            data-access-token="<%= access_token %>">
                        Last 6 Months
                    </button>
                    <button type="button" 
                            class="time-range-button <%= time_range === 'long_term' ? 'active' : '' %>" 
                            data-time-range="long_term" 
                            data-content-type="top-tracks" 
                            data-access-token="<%= access_token %>">
                        All Time
                    </button>
                </div>
            </div>
        </div>
        
        <div id="top-tracks-content" class="content-container">
            <div class="tracks-grid">
                <% tracks.forEach((track, index) => { %>
                    <div class="track-card">
                        <!-- Track content -->
                        <div class="track-number"><%= index + 1 %></div>
                        <div class="track-image">
                            <img src="<%= track.album.images[0]?.url || '/img/default-album.png' %>" alt="<%= track.name %>">
                        </div>
                        <div class="track-info">
                            <div class="track-name"><%= track.name %></div>
                            <div class="track-artist"><%= track.artists.map(artist => artist.name).join(', ') %></div>
                            <div class="track-album"><%= track.album.name %></div>
                        </div>
                        <div class="track-actions">
                            <a href="<%= track.external_urls.spotify %>" target="_blank" class="spotify-link">
                                <i class="fas fa-external-link-alt"></i> Open in Spotify
                            </a>
                        </div>
                    </div>
                <% }); %>
            </div>
        </div>
        
        <!-- Include the AJAX functionality script -->
        <script src="/js/ajax-content.js"></script>
      <% } %>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Solo per dispositivi mobili
        if (window.innerWidth <= 480) {
          const trackItems = document.querySelectorAll('.track-item');
          
          trackItems.forEach(item => {
            // Ottiene l'URL Spotify dall'attributo data
            const spotifyUrl = item.getAttribute('data-spotify-url');
            const overlay = item.querySelector('.track-play-overlay');
            
            // Aggiunge evento touch/click
            item.addEventListener('click', function(e) {
              // Se l'overlay è già attivo, apri il link
              if (overlay.classList.contains('active')) {
                window.open(spotifyUrl, '_blank');
                setTimeout(() => {
                  overlay.classList.remove('active');
                }, 500);
              } else {
                // Altrimenti, mostra l'overlay
                e.preventDefault();
                
                // Prima rimuovi tutti gli altri overlay attivi
                document.querySelectorAll('.track-play-overlay.active').forEach(el => {
                  if (el !== overlay) el.classList.remove('active');
                });
                
                // Attiva questo overlay
                overlay.classList.add('active');
                
                // Auto-nascondi dopo 3 secondi
                setTimeout(() => {
                  overlay.classList.remove('active');
                }, 3000);
              }
            });
          });
        }
      });
    </script>
  </body>
</html>
